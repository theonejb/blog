<!doctype html><html lang="en" dir="ltr"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><title>Cookie Based Auth for Django and NextJS | Jibran’s Perspective</title><meta name="description" content="A collection of my thoughts and stuff." /><link href="/feed.xml" rel="alternate" type="application/atom+xml" /><link rel="canonical" href="/cookie-based-auth-for-django-and-nextjs" /><link rel="stylesheet" href="/assets/style.css" /> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-VXRED3HCM0" ></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag("js", new Date()); gtag("config", "G-VXRED3HCM0"); </script><body><main><h2 class="title">Jibran’s Perspective</h2><nav> <a href="https://blog.asadjb.com">Home</a> <a href="https://blog.asadjb.com/about-me/">About Me</a></nav><h1>Cookie Based Auth for Django and NextJS</h1><i>Mar 03, 2024</i><h4 class="subtitle"></h4><blockquote><p>If you’re just looking for implementation instructions, skip my ramblings and go straight to the <a href="#implementation">code here</a>.</p></blockquote><p>I’m currently working on my <a href="/project-1-django-nextjs-boilerplate">first project</a> after deciding that I needed to <a href="/i-have-not-failed-enough">fail more</a> and practice finishing projects instead of abandoning them midway once they got “boring”.</p><p>Anyways… This one is till in it’s interesting phase, so here’s a blog post with some things I learned yesterday while working on it.</p><p>The project is a <a href="https://asadjb.gumroad.com/l/nextjs-django-template">boilerplate template</a> that should make it easy for devs. to start a new project with a Django backend and a Next.js frontend, something I had to struggle with recently.</p><h2 id="the-problem">The problem</h2><p>The first thing I’m looking to solve is authentication. That was my biggest challenge when working on the contracting project that inspired this template.</p><p>While there are a number of good posts around how to setup authentication b/w Django &amp; Next.js, nothing “definitive” came up and I had to cobble together a weird mess of Django+DRF (Django Rest Framework) and Next.js+NextAuth, sharing a token from Django that was masquarading as a JWT token for Next.js. It wasn’t pretty and I knew I could do better.</p><h2 id="the-options">The options</h2><p>I considered 2 options for authenticating the Next.js frontend with the Django backend:</p><ol><li>Token based auth. On logging in, a user receives a token that is stored in local storage by the frontend and send with every request to the backend.<li>Session/Cookie based auth. This is how authentication works in Django by default and is very easy to get started with - it basically comes for free out of the box when you start a new Django project.</ol><p>While token based auth. is what almost everyone suggests to use when using a Next.js frontend with any backend technology, I wanted to give session based auth. a try. I was curious what it would take to make it work - if it was even possible.</p><p><strong>tl;dr:</strong> It was possible to use cookie/session auth. b/w Django &amp; Next.js - though with a few constraints which make it less appealing than the token based solution</p><p>What follows are my notes on how to set it up, the problems I faced, and why for the template I’m going to go with token based auth. instead.</p><h2 id="learning-how-cors--set-cookie-works">Learning how CORS &amp; Set-Cookie works</h2><p>It took me a few hours to get my head around how cross-origin requests and cookies work together, but the actual implementation was surprisingly straight forward.</p><p>This “mini-quest” gave me a chance to learn a lot about how CORS and cookies work, and I’m happy with the time I spent on this. These are the resources which helped me the most (all are from MDN):</p><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">Same-origin policy</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">Using HTTP cookies</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value">Set-Cookie</a></ul><p>And finally, there was a surprise waiting for me! Browsers are almost universally making changes to restrict 3rd party or cross-domain cookies because of their privacy implications. Here’s a nice article from MDN about it: <a href="https://developer.mozilla.org/en-US/blog/goodbye-third-party-cookies/">Saying goodbye to third-party cookies in 2024</a>.</p><p>This is the reason why; while this approach works, I won’t be using it in the template. <a href="#why-not">More on that later</a>.</p><h2 id="implementation">Implementation</h2><p>Implementing the session based auth. b/w Django &amp; Next.js is pretty simple.</p><h3 id="django-configuration">Django configuration</h3><ol><li>Install the <a href="https://github.com/adamchainz/django-cors-headers"><code>django-cors-headers</code></a> Python package.<ol><li>Add <code>"corsheaders",</code> to your <code>INSTALLED_APPS</code>.<li>Add the <code>"corsheaders.middleware.CorsMiddleware",</code> middleware, right above the existing <code>CommonMiddleware</code>.<li>Set <code>CORS_ALLOWED_ORIGINS = ["http://localhost:3000"]</code>, replacing the URL with your frontend URL.<li>Set <code>CORS_ALLOW_CREDENTIALS = True</code></ol><li>Configure <code>settings.py</code> to allow cross-domain access for the session cookie.<ol><li>Set <code>SESSION_COOKIE_SAMESITE = "None"</code><li>Set <code>SESSION_COOKIE_SECURE = True</code></ol></ol><h3 id="nextjs-configuration">Next.js configuration</h3><p>No configuration is needed on the frontend. However, you do need to use the <code>credentials: "include",</code> option when using the <code>fetch()</code> API to access your backend.</p><p>Here’s a minimal example.</p><div class="language-javascript highlighter-coderay"><div class="CodeRay"><div class="code"><pre><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">use client</span><span style="color:#710">&quot;</span></span>;

<span style="color:#080;font-weight:bold">import</span> { BACKEND_URL } from <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">@/constants</span><span style="color:#710">&quot;</span></span>;

async <span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">signIn</span>() {
  const loginData = <span style="color:#080;font-weight:bold">new</span> FormData();
  loginData.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">username</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">admin</span><span style="color:#710">&quot;</span></span>);
  loginData.append(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">password</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">admin</span><span style="color:#710">&quot;</span></span>);

  <span style="color:#080;font-weight:bold">return</span> await fetch(<span style="color:#F00;background-color:#FAA">`</span><span style="color:#369;font-weight:bold">$</span>{BACKEND_URL}/accounts/login/<span style="color:#F00;background-color:#FAA">`</span>, {
    <span style="color:#606">method</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">POST</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606">body</span>: loginData,
    <span style="color:#606">credentials</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">include</span><span style="color:#710">&quot;</span></span>,
  });
}

async <span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">whoAmI</span>() {
  console.log(
    await fetch(<span style="color:#F00;background-color:#FAA">`</span><span style="color:#369;font-weight:bold">$</span>{BACKEND_URL}/accounts/me/<span style="color:#F00;background-color:#FAA">`</span>, {
      <span style="color:#606">method</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GET</span><span style="color:#710">&quot;</span></span>,
      <span style="color:#606">credentials</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">include</span><span style="color:#710">&quot;</span></span>,
    }),
  );
}

<span style="color:#080;font-weight:bold">export</span> <span style="color:#080;font-weight:bold">default</span> <span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">Home</span>() {
  <span style="color:#080;font-weight:bold">return</span> (
    <span style="color:#070;font-weight:bold">&lt;main</span> <span style="color:#b48">className</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">flex min-h-dvh w-full flex-col justify-around</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;h1</span> <span style="color:#b48">className</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text-center</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>Home<span style="color:#070;font-weight:bold">&lt;/h1&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;button</span> <span style="color:#b48">className</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">onClick</span>=<span style="color:#F00;background-color:#FAA">{</span><span style="color:#700">signIn</span><span style="color:#F00;background-color:#FAA">}</span><span style="color:#070;font-weight:bold">&gt;</span>
        Sign In
      <span style="color:#070;font-weight:bold">&lt;/button&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;button</span> <span style="color:#b48">onClick</span>=<span style="color:#F00;background-color:#FAA">{</span><span style="color:#700">whoAmI</span><span style="color:#F00;background-color:#FAA">}</span><span style="color:#070;font-weight:bold">&gt;</span>Who Am I<span style="color:#070;font-weight:bold">&lt;/button&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/main&gt;</span>
  );
}
</pre></div></div></div><p>That’s it. That simple piece of code &amp; configuration took me hours to find. Hopefully you can use this example to skip all that time spent trying to figure things out.</p><p><em>Side quest log</em>: Initially, I was not using the <code>credentials: "include"</code> option in the <code>signIn()</code> function above; thinking that I didn’t need to send any cookies with the login call, only the second API call to the <code>/accounts/me</code> endpoint.</p><p>That mistake cost me about 2 hours of debugging time. If I had <a href="https://developer.mozilla.org/en-US/docs/Web/API/fetch#credentials">RTFM</a> correctly the first time, I would have seen this:</p><blockquote><p><code>include</code>: Tells browsers to include credentials in both same- and cross-origin requests, and always use any credentials sent back in responses.</p></blockquote><p>The <code>credentials: "include"</code> not only controls if cookies are sent, but also if they are saved when returned by the server.</p><h2 id="why-not">Why I won’t use this solution in the template</h2><p>Browsers are phasing out 3rd party cookies (<a href="https://developer.mozilla.org/en-US/blog/goodbye-third-party-cookies/">Saying goodbye to third-party cookies in 2024</a>) and adding features to work around that restriction where needed.</p><p>The simplest way that doesn’t require much change is to use <a href="https://developer.mozilla.org/en-US/docs/Web/Privacy/Privacy_sandbox/Partitioned_cookies">Cookies Having Independent Partitioned State (CHIPS)</a>.</p><p>To enable CHIPS, you simply put a <code>Partitioned</code> flag on your <code>Set-Cookie</code> header, like so:</p><p><code>Set-Cookie: session_id=1234; SameSite=None; Secure; Path=/; Partitioned;</code></p><p>Unfortunately, there’s no straight forward way to do this in Django for now. There’s an open issue to resolve this, but looking at the comments, it won’t likely be solved anytime soon.</p><p>Considering this, I opted to use the token based auth. method for my template. I’ll write a blog on that once I get it working over the next few days.</p></main><footer> <a href="/">← Back to all writings</a><div class="bottom-footer"> <i> Powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>. </i> <i> Theme: <a href="https://knhash.in/jekyllBear" target="_blank">jekyllBear</a>. </i></div></footer>
